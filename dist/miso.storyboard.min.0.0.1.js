/**
* Miso.Storyboard - v0.0.1 - 3/23/2013
* http://github.com/misoproject/storyboard
* Copyright (c) 2013 Alex Graul, Irene Ros, Rich Harris;
* Dual Licensed: MIT, GPL
* https://github.com/misoproject/storyboard/blob/master/LICENSE-MIT 
* https://github.com/misoproject/storyboard/blob/master/LICENSE-GPL 
*/(function(t,_){var n=t.Miso=t.Miso||{};n.Events={publish:function(t){var n=_.toArray(arguments);return n.shift(),this._events&&this._events[t]&&_.each(this._events[t],function(t){t.callback.apply(t.context||this,n)},this),this},subscribe:function(t,n,i){i=i||{},this._events=this._events||{},this._events[t]=this._events[t]||[];var e,s={callback:n,priority:i.priority||0,token:i.token||_.uniqueId("t"),context:i.context||this};return _.each(this._events[t],function(t,n){_.isUndefined(e)&&t.priority<=s.priority&&(e=n)}),this._events[t].splice(e,0,s),s.token},subscribeOnce:function(t,n){this._events=this._events||{};var i=_.uniqueId("t");return this.subscribe(t,function(){this.unsubscribe(t,{token:i}),n.apply(this,arguments)},this,i)},unsubscribe:function(t,n){return _.isUndefined(this._events[t])?this:(this._events[t]=_.isFunction(n)?_.reject(this._events[t],function(t){return t.callback===n}):_.isString(n)?_.reject(this._events[t],function(t){return t.token===n}):[],this)}}})(this,_),function(t,_){function n(t,n,i){this._transitioning=!0;var e=this._complete=i||_.Deferred(),s=n?n:[],r=_.Deferred().done(_.bind(function(){this._transitioning=!1,this._current=t,e.resolve()},this)).fail(_.bind(function(){this._transitioning=!1,e.reject()},this));return this.handlers[t].call(this._context,s,r),e.promise()}function i(t,n,i){var e=this.scenes[t],s=this._current,r=n?n:[],o=this._complete=i||_.Deferred(),c=_.Deferred(),h=_.Deferred(),u=_.bind(function(t,n){var i=n?s:e;i=i?i.name:"",this.publish(t,s,e),("start"!==t||"end"!==t)&&this.publish(i+":"+t)},this),a=_.bind(function(){this._transitioning=!1,this._current=s,u("fail"),o.reject()},this),f=_.bind(function(){u("enter"),this._transitioning=!1,this._current=e,u("end"),o.resolve()},this);if(!e)throw"Scene '"+t+"' not found!";return this._transitioning?o.reject():(u("start"),this._transitioning=!0,s?(s.to("exit",r,c),c.done(function(){u("exit",!0)})):c.resolve(),_.when(c).then(function(){e.to("enter",r,h)}).fail(a),h.then(f).fail(a),o.promise())}function e(t,n){if(!_.isFunction(t))return t;if(/^_/.test(n))return t;if(t.__wrapped)return t;var i=function(n,i){var e,s=!1;return i=i||_.Deferred(),this.async=function(){return s=!0,function(t){return t!==!1?i.resolve():i.reject()}},e=t.apply(this,n),this.async=void 0,s?i.promise():e!==!1?i.resolve():i.reject()};return i.__wrapped=!0,i}var s=t.Miso=t.Miso||{},r=s.Storyboard=function(t){t=t||{},this._originalOptions=t,this._context=t.context||this,this._id=_.uniqueId("scene"),t.scenes?(this._buildScenes(t.scenes),this._initial=t.initial,this.to=i):(this.handlers={},_.each(r.HANDLERS,function(n){t[n]=t[n]||function(){return!0},this.handlers[n]=e(t[n],n)},this),this.to=n),_.each(t,function(t,n){-1===_.indexOf(r.BLACKLIST,n)&&(this[n]=_.isFunction(t)?function(n){return function(){t.apply(n._context||n,arguments)}}(this):t)},this)};r.HANDLERS=["enter","exit"],r.BLACKLIST=["_id","initial","scenes","enter","exit","context","_current"],_.extend(r.prototype,s.Events,{clone:function(){return this.scenes&&_.each(this._originalOptions.scenes,function(t,n){t instanceof s.Storyboard&&(this._originalOptions.scenes[n]=t.clone())},this),new s.Storyboard(this._originalOptions)},attach:function(t,n){return this.name=t,this.parent=n,n._context&&n._context._id!==n._id&&(this._context=n._context,this.scenes&&_.each(this.scenes,function(t){t.attach(t.name,this)},this)),this},start:function(){return this._current!==void 0?_.Deferred().resolve():this.to(this._initial)},cancelTransition:function(){this._complete.reject(),this._transitioning=!1},scene:function(){return this._current?this._current.name:null},is:function(t){return t===this._current.name},inTransition:function(){return this._transitioning===!0},setContext:function(t){this._context=t,this.scenes&&_.each(this.scenes,function(n){n.setContext(t)})},_buildScenes:function(t){this.scenes={},_.each(t,function(t,n){this.scenes[n]=t instanceof s.Storyboard?t:new s.Storyboard(t),this.scenes[n].attach(n,this)},this)}})}(this,_);