/**
* Miso.Storyboard - v0.0.1 - 11/7/2012
* http://github.com/misoproject/storyboard
* Copyright (c) 2012 Alex Graul, Irene Ros, Rich Harris;
* Dual Licensed: MIT, GPL
* https://github.com/misoproject/storyboard/blob/master/LICENSE-MIT 
*/
(function(e,_){var t=e.Miso=e.Miso||{};t.Events={publish:function(e){var t=_.toArray(arguments);t.shift(),this._events&&this._events[e]&&_.each(this._events[e],function(e){e.callback.apply(e.context||this,t)},this)},subscribe:function(e,t,n){n=n||{},this._events=this._events||{},this._events[e]=this._events[e]||[];var r={callback:t,priority:n.priority||0,token:n.token||_.uniqueId("t"),context:n.context||this},i;return _.each(this._events[e],function(e,t){if(!_.isUndefined(i))return;e.priority<=r.priority&&(i=t)}),this._events[e].splice(i,0,r),r.token},subscribeOnce:function(e,t){this._events=this._events||{};var n=_.uniqueId("t");return this.subscribe(e,function(){this.unsubscribe(e,{token:n}),t.apply(this,arguments)},this,n)},unsubscribe:function(e,t){if(_.isUndefined(this._events[e]))return this;_.isFunction(t)?this._events[e]=_.reject(this._events[e],function(e){return e.callback===t}):_.isString(t)?this._events[e]=_.reject(this._events[e],function(e){return e.token===t}):this._events[e]=[]}}})(this,_),function(e,_){function r(e,t,n){this._transitioning=!0;var r=this._complete=n||_.Deferred(),i=t?t:[],s=_.Deferred().done(_.bind(function(){this._transitioning=!1,this._current=e,r.resolve()},this)).fail(_.bind(function(){this._transitioning=!1,r.reject()},this));return this.handlers[e].call(this._context,i,s),r.promise()}function i(e,t,n){var r=this.scenes[e],i=this._current,s=t?t:[],o=this._complete=n||_.Deferred(),u=_.Deferred(),a=_.Deferred(),f=_.bind(function(e){this.publish(e,i?i.name:null,r.name)},this),l=_.bind(function(){this._transitioning=!1,o.reject(),f("fail")},this),c=_.bind(function(){this._transitioning=!1,this._current=r,o.resolve(),f("done")},this);if(!r)throw"Scene '"+e+"' not found!";return f("start"),this._transitioning?o.reject():(this._transitioning=!0,i?i.to("exit",s,u).done(function(){r.to("enter",s,a).fail(l)}).fail(l):(u.resolve(),r.to("enter",s,a).fail(l)),_.when(u,a).then(c),o.promise())}function s(e,t){if(!_.isFunction(e))return e;if(/^_/.test(t))return e;if(e.__wrapped)return e;var n=function(t,n){var r=!1,i;return n=n||_.Deferred(),this.async=function(){return r=!0,function(e){return e!==!1?n.resolve():n.reject()}},i=e.apply(this,t),this.async=undefined,r?n.promise():i!==!1?n.resolve():n.reject()};return n.__wrapped=!0,n}var t=e.Miso=e.Miso||{},n=t.Storyboard=function(e){e=e||{},this._context=e.context||this,this._id=_.uniqueId("scene"),e.scenes?(this._buildScenes(e.scenes),this._initial=e.initial,this.to=i):(this.handlers={},_.each(n.HANDLERS,function(t){e[t]=e[t]||function(){return!0},this.handlers[t]=s(e[t],t)},this),this.to=r),_.each(e,function(e,t){if(_.indexOf(n.BLACKLIST,t)!==-1)return;this[t]=e},this)};n.HANDLERS=["enter","exit"],n.BLACKLIST=["initial","scenes","enter","exit","context"],_.extend(n.prototype,t.Events,{attach:function(e,t){return this.name=e,this.parent=t,t._context&&t._context._id!==t._id&&(this._context=t._context,this.scenes&&_.each(this.scenes,function(e){e.attach(e.name,this)},this)),this},start:function(){return typeof this._current!="undefined"?_.Deferred().resolve():this.to(this._initial)},cancelTransition:function(){this._complete.reject(),this._transitioning=!1},scene:function(){return this._current?this._current.name:null},is:function(e){return e===this._current.name},inTransition:function(){return this._transitioning===!0},_buildScenes:function(e){this.scenes={},_.each(e,function(e,n){this.scenes[n]=e instanceof t.Storyboard?e:new t.Storyboard(e),this.scenes[n].attach(n,this)},this)}})}(this,_);