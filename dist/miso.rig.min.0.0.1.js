/**
* Miso.Rig - v0.0.1 - 9/13/2012
* http://github.com/misoproject/rig
* Copyright (c) 2012 Alex Graul, Irene Ros, Rich Harris;
* Dual Licensed: MIT, GPL
* https://github.com/misoproject/rig/blob/master/LICENSE-MIT 
* https://github.com/misoproject/rig/blob/master/LICENSE-GPL 
*/
(function(a,_){var b=a.Miso=a.Miso||{};b.Rig=function(a){this._buildScenes(a.scenes),this._triggers={},_.each(a,function(a,b){if(_.indexOf(c.BLACKLIST,b)!==-1)return;this[b]=a},this),a.defer?this._initial=a.initial:this.to(a.initial)};var c=b.Rig;c.ERRORS={},c.BLACKLIST=["initial","scenes","defer"],_.extend(c.prototype,{attach:function(a,b){this.name=a,this.rig=b},start:function(){return this._current?_.Deferred().reject().promise():this.to(this._initial)},cancelTransition:function(){this._complete.reject(),this._transitioning=!1},to:function(a,b,c){var d=this.scenes[a],e=this._current,f=b?b:[],g=this._complete=c||_.Deferred(),h=_.Deferred(),i=_.Deferred(),j=_.bind(function(){this._transitioning=!1,g.reject()},this),k=_.bind(function(){this._transitioning=!1,this._current=d,g.resolve()},this);if(!d)throw"Scene '"+a+"' not found!";return this._transitioning?g.reject():(this._transitioning=!0,e?e.to("exit",f,h).done(function(){d.to("enter",f,i).fail(j)}).fail(j):(h.resolve(),d.to("enter",f,i).fail(j)),_.when(h,i).then(k),g.promise())},scene:function(){return this._current?this._current.name:null},is:function(a){return a===this._current.name},inTransition:function(){return this._transitioning===!0},_buildScenes:function(a){this.scenes={},_.each(a,function(a,c){var d;a instanceof b.Scene||a instanceof b.Rig?d=a:d=new b.Scene(a),d.attach(c,this),this.scenes[c]=d},this)},_publish:function(a){var b=_.toArray(arguments);b.shift(),this._triggers&&this._triggers[a]&&_.each(this._triggers[a],function(a){a.callback.apply(a.context||this,b)},this)},subscribe:function(a,b,c,d){this._triggers[a]=this._triggers[a]||[];var e={callback:b,token:d||_.uniqueId("t"),context:c||this};return this._triggers[a].push(e),e.token}})})(this,_),function(a,_){function c(a){return function(b,c){var d=!1,e;return this.async=function(){return d=!0,function(a){return a!==!1?b.resolve():b.reject()}},e=a.apply(this,c),this.async=undefined,d?b.promise():e!==!1?b.resolve():b.reject()}}var b=a.Miso=a.Miso||{};b.Scene=function(a){this.triggers={},this.handlers={};var b=["enter","exit"];_.each(b,function(b){a[b]=a[b]||function(){return!0},this.handlers[b]=c(a[b])},this),_.each(a,function(a,c){if(_.indexOf(b,c)!==-1)return;this[c]=a},this)},_.extend(b.Scene.prototype,b.Rig.prototype,{to:function(a,b,c){this._transitioning=!0;var d=this._complete=c||_.Deferred(),e=b?b:[],f=_.Deferred().done(_.bind(function(){this._transitioning=!1,this._current=a,d.resolve()},this)).fail(_.bind(function(){this._transitioning=!1,d.reject()},this));return this.handlers[a].call(this,f,e),d.promise()}})}(this,_)